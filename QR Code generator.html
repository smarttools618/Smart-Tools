<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QR Code Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary-light-theme: #4361ee;
            --primary-light-light-theme: #5a75f5;
            --accent-light-theme: #4895ef;
            --card-bg-light-theme: #ffffff;
            --body-bg-light-theme: #f0f4f8;
            --text-color-light-theme: #1a202c;
            --input-bg-light-theme: #ffffff;
            --border-color-light-theme: #cbd5e0;
            --result-bg-light-theme: #f0f7ff;
            --gray-light-theme: #718096;
            --light-gray-light-theme: #e2e8f0;
            --footer-bg-light-theme: #f0f4f8;
            --footer-color-light-theme: #718096;

            --primary-dark-theme: #5a75f5; /* Lighter primary for dark mode */
            --primary-light-dark-theme: #7c92fa;
            --accent-dark-theme: #6caeff;
            --card-bg-dark-theme: #1f2937; /* Darker card */
            --body-bg-dark-theme: #111827; /* Very dark body */
            --text-color-dark-theme: #f3f4f6; /* Light text */
            --input-bg-dark-theme: #374151; /* Darker input */
            --border-color-dark-theme: #4b5563; /* Lighter border for contrast */
            --result-bg-dark-theme: #1a222f;
            --gray-dark-theme: #9ca3af;
            --light-gray-dark-theme: #4b5563;
            --footer-bg-dark-theme: #1f2937;
            --footer-color-dark-theme: #9ca3af;

            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --success: #48bb78;
            --transition: all 0.3s ease;
        }

        body {
            background: var(--body-bg);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            --primary: var(--primary-dark-theme);
            --primary-light: var(--primary-light-dark-theme);
            --accent: var(--accent-dark-theme);
            --card-bg: var(--card-bg-dark-theme);
            --body-bg: var(--body-bg-dark-theme);
            --text-color: var(--text-color-dark-theme);
            --input-bg: var(--input-bg-dark-theme);
            --border-color: var(--border-color-dark-theme);
            --result-bg: var(--result-bg-dark-theme);
            --gray: var(--gray-dark-theme);
            --light-gray: var(--light-gray-dark-theme);
            --footer-bg: var(--footer-bg-dark-theme);
            --footer-color: var(--footer-color-dark-theme);
        }

        body:not(.dark-mode) {
            --primary: var(--primary-light-theme);
            --primary-light: var(--primary-light-light-theme);
            --accent: var(--accent-light-theme);
            --card-bg: var(--card-bg-light-theme);
            --body-bg: var(--body-bg-light-theme);
            --text-color: var(--text-color-light-theme);
            --input-bg: var(--input-bg-light-theme);
            --border-color: var(--border-color-light-theme);
            --result-bg: var(--result-bg-light-theme);
            --gray: var(--gray-light-theme);
            --light-gray: var(--light-gray-light-theme);
            --footer-bg: var(--footer-bg-light-theme);
            --footer-color: var(--footer-color-light-theme);
        }

        .container {
            max-width: 700px;
            width: 100%;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            width: 100%;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--card-shadow);
        }
        .logo-icon i {
            font-size: 24px;
            color: white;
        }
        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
        }
        .header-controls {
            display: flex;
            gap: 10px; /* Reduced gap */
            align-items: center;
        }
        .control-btn, .lang-btn { /* Combined for theme toggle */
            display: flex;
            align-items: center;
            justify-content: center; /* For icon-only buttons */
            padding: 10px;
            background: var(--card-bg);
            border: none;
            border-radius: 50px; /* Make it circular if icon only */
            color: var(--text-color);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
            text-decoration: none;
            min-width: 44px; /* Ensure touch target size */
            min-height: 44px;
        }
        .home-btn { /* Specific for home if it has text */
             padding: 10px 20px;
             gap: 8px;
        }
        .control-btn:hover, .lang-btn:hover, .home-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
        }
        .lang-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .lang-btn {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
             min-width: auto; /* Override for lang buttons */
             min-height: auto;
        }
        .lang-btn.active {
            background: var(--primary);
            color: white;
        }
        #themeToggleBtn i {
            font-size: 18px;
        }

        .tool-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 40px;
        }
        .tool-header {
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tool-header h2 {
            font-size: 24px;
            color: var(--text-color);
        }
        .tool-header i {
            font-size: 24px;
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        .input-group input[type="text"],
        .input-group input[type="email"],
        .input-group input[type="tel"],
        .input-group input[type="url"],
        .input-group input[type="number"],
        .input-group input[type="datetime-local"],
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: var(--transition);
            color: var(--text-color);
            box-sizing: border-box;
        }
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        .input-group.checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-group.checkbox-group input[type="checkbox"] {
            width: auto;
            accent-color: var(--primary);
        }

        .qr-type-explanation {
            font-size: 0.9em;
            color: var(--gray);
            margin-top: -10px;
            margin-bottom: 20px;
            padding: 8px 12px;
            background-color: var(--result-bg);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        [dir="rtl"] .qr-type-explanation {
            border-left: none;
            border-right: 3px solid var(--accent);
        }


        .qr-display-container {
            margin-top: 25px;
            padding: 10px; /* Reduced padding if canvas bg is white */
            background: var(--result-bg);
            border-radius: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #qrCodeCanvas {
            width: 400px !important; /* Fixed size as requested */
            height: 400px !important; /* Fixed size as requested */
            max-width: 100%;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background-color: white; /* QR codes need white background usually */
        }
        .qr-placeholder-text {
            font-size: 16px;
            color: var(--gray);
            width: 400px; /* Match canvas */
            height: 400px; /* Match canvas */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
        }
        .action-button {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
        }
        .action-button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        .action-button i { margin-right: 8px; }
        [dir="rtl"] .action-button i { margin-right: 0; margin-left: 8px; }

        footer {
            text-align: center;
            padding: 30px 0;
            margin-top: auto;
            width: 100%;
            color: var(--footer-color);
            background: var(--footer-bg);
            border-radius: 15px;
        }
        .contact-email { font-size: 18px; margin-top: 10px; }
        .contact-email a { color: var(--primary); text-decoration: none; transition: var(--transition); font-weight: 600; }
        .contact-email a:hover { text-decoration: underline; }

        .input-wrapper { position: relative; }
        .clear-btn { /* For textareas if needed */
            position: absolute;
            right: 12px; top: 10px;
            background: transparent; border: none; font-size: 16px; cursor: pointer;
            color: var(--gray); padding: 5px; display: none; line-height: 1; z-index: 2;
        }
        .clear-btn:hover { color: var(--text-color); }
        [dir="rtl"] .clear-btn { right: auto; left: 12px; }

        /* Responsive adjustments for large QR */
        @media (max-width: 500px) {
            #qrCodeCanvas, .qr-placeholder-text {
                width: 100% !important;
                height: auto !important;
                aspect-ratio: 1 / 1; /* Maintain square */
            }
            .tool-card { padding: 20px; }
        }
        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; }
            .logo { justify-content: center; }
            .header-controls { width: 100%; justify-content: center; }
            .tool-card { padding: 15px; }
        }
        @media (max-width: 480px) {
            .logo h1 { font-size: 20px; }
            .tool-header h2 { font-size: 18px; }
            .action-button { font-size: 16px; }
            .home-btn, .lang-btn { padding: 7px 10px; font-size: 12px; }
            .control-btn { padding: 8px; }
            #themeToggleBtn i { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-qrcode"></i></div>
                <h1 id="appTitle">Smart QR Code Generator</h1>
            </div>
            <div class="header-controls">
                <button id="themeToggleBtn" class="control-btn" title="Toggle theme">
                    <i class="fas fa-sun"></i> <!-- Icon changes with theme -->
                </button>
                <a href="https://smrttoolz.blogspot.com/" class="home-btn control-btn" target="_self">
                    <i class="fas fa-home"></i> <span id="homeText">Home</span>
                </a>
                <div class="lang-buttons">
                    <button class="lang-btn active" data-lang="en">EN</button>
                    <button class="lang-btn" data-lang="fr">FR</button>
                    <button class="lang-btn" data-lang="ar">ع</button>
                </div>
            </div>
        </header>

        <div class="tool-card">
            <div class="tool-header">
                <h2 id="toolTitle">QR Code Generator</h2>
                <i class="fas fa-qrcode"></i>
            </div>

            <div class="input-group">
                <label for="qrTypeSelect" id="qrTypeSelectLabel">QR Code Type</label>
                <select id="qrTypeSelect">
                    <option value="text">Text / URL</option>
                    <option value="email">Email</option>
                    <option value="sms">SMS</option>
                    <option value="phone">Phone Call</option>
                    <option value="wifi">WiFi Network</option>
                    <option value="contact">Contact (vCard)</option>
                    <option value="event">Calendar Event</option>
                    <option value="geo">Geolocation</option>
                </select>
            </div>
            <div id="qrTypeExplanation" class="qr-type-explanation" style="display:none;"></div>

            <div id="dynamicInputsContainer">
                <!-- Input fields will be dynamically inserted here -->
            </div>

            <button id="generateBtn" class="action-button">
                <i class="fas fa-cogs"></i> <span id="generateBtnText">Generate QR Code</span>
            </button>

            <div class="qr-display-container">
                <canvas id="qrCodeCanvas" style="display: none;"></canvas>
                <p id="qrPlaceholder" class="qr-placeholder-text">QR Code will appear here</p>
            </div>

            <button id="downloadBtn" class="action-button" style="display: none; background-color: var(--accent);">
                <i class="fas fa-download"></i> <span id="downloadBtnText">Download</span>
            </button>
        </div>
    </div>

    <footer>
        <div class="contact-email">
            <span id="contactText">Contact us:</span>
            <a href="mailto:smarttools618@gmail.com">smarttools618@gmail.com</a>
        </div>
    </footer>

    <script>
        // --- Language Data ---
        const languages = {
            en: {
                appTitle: "Smart QR Code Generator", home: "Home", toolTitle: "QR Code Generator",
                qrTypeSelectLabel: "QR Code Type",
                generateBtnText: "Generate QR Code", downloadBtnText: "Download",
                qrPlaceholder: "QR Code will appear here", contactText: "Contact us:",
                themeToggleTitleLight: "Switch to Dark Mode", themeToggleTitleDark: "Switch to Light Mode",
                qrTypes: {
                    text: { name: "Text / URL", explanation: "Encode any text or web address (URL)." },
                    email: { name: "Email", explanation: "Create a QR code to draft an email." },
                    sms: { name: "SMS", explanation: "Generate a QR code to send an SMS message." },
                    phone: { name: "Phone Call", explanation: "Make a QR code to initiate a phone call." },
                    wifi: { name: "WiFi Network", explanation: "Share WiFi credentials easily." },
                    contact: { name: "Contact (vCard)", explanation: "Share contact details for address books." },
                    event: { name: "Calendar Event", explanation: "Create a QR for a calendar event." },
                    geo: { name: "Geolocation", explanation: "Share a specific map location." }
                },
                fields: { // Labels for dynamic fields
                    textData: "Text or URL",
                    emailTo: "To (Email Address)", emailSubject: "Subject", emailBody: "Body",
                    smsNumber: "Phone Number", smsMessage: "Message",
                    phoneNumber: "Phone Number",
                    wifiSsid: "Network Name (SSID)", wifiPassword: "Password", wifiEncryption: "Encryption", wifiHidden: "Hidden Network",
                    contactFirstName: "First Name", contactLastName: "Last Name", contactOrg: "Organization", contactTitle: "Job Title",
                    contactPhoneMobile: "Mobile Phone", contactPhoneWork: "Work Phone", contactEmail: "Email", contactWebsite: "Website", contactAddress: "Address (Street, City, ZIP, Country)",
                    eventTitle: "Event Title", eventStart: "Start Date & Time", eventEnd: "End Date & Time", eventLocation: "Location", eventDescription: "Description",
                    geoLatitude: "Latitude", geoLongitude: "Longitude"
                },
                wifiEncryptionOptions: { none: "None", WEP: "WEP", WPA: "WPA/WPA2" }
            },
            fr: {
                appTitle: "Générateur de code QR intelligent", home: "Accueil", toolTitle: "Générateur de code QR",
                qrTypeSelectLabel: "Type de code QR",
                generateBtnText: "Générer le code QR", downloadBtnText: "Télécharger",
                qrPlaceholder: "Le code QR apparaîtra ici", contactText: "Contactez-nous:",
                themeToggleTitleLight: "Passer en mode sombre", themeToggleTitleDark: "Passer en mode clair",
                qrTypes: {
                    text: { name: "Texte / URL", explanation: "Encodez du texte ou une adresse web (URL)." },
                    email: { name: "Email", explanation: "Créez un code QR pour rédiger un email." },
                    sms: { name: "SMS", explanation: "Générez un code QR pour envoyer un SMS." },
                    phone: { name: "Appel téléphonique", explanation: "Créez un code QR pour lancer un appel." },
                    wifi: { name: "Réseau WiFi", explanation: "Partagez facilement les identifiants WiFi." },
                    contact: { name: "Contact (vCard)", explanation: "Partagez des coordonnées pour carnets d'adresses." },
                    event: { name: "Événement de calendrier", explanation: "Créez un QR pour un événement de calendrier." },
                    geo: { name: "Géolocalisation", explanation: "Partagez une position géographique spécifique." }
                },
                fields: {
                    textData: "Texte ou URL",
                    emailTo: "Destinataire (Adresse e-mail)", emailSubject: "Sujet", emailBody: "Corps du message",
                    smsNumber: "Numéro de téléphone", smsMessage: "Message",
                    phoneNumber: "Numéro de téléphone",
                    wifiSsid: "Nom du réseau (SSID)", wifiPassword: "Mot de passe", wifiEncryption: "Cryptage", wifiHidden: "Réseau masqué",
                    contactFirstName: "Prénom", contactLastName: "Nom", contactOrg: "Organisation", contactTitle: "Titre/Poste",
                    contactPhoneMobile: "Téléphone portable", contactPhoneWork: "Téléphone travail", contactEmail: "E-mail", contactWebsite: "Site Web", contactAddress: "Adresse (Rue, Ville, CP, Pays)",
                    eventTitle: "Titre de l'événement", eventStart: "Date et heure de début", eventEnd: "Date et heure de fin", eventLocation: "Lieu", eventDescription: "Description",
                    geoLatitude: "Latitude", geoLongitude: "Longitude"
                },
                wifiEncryptionOptions: { none: "Aucun", WEP: "WEP", WPA: "WPA/WPA2" }
            },
            ar: {
                appTitle: "مولد رموز QR الذكي", home: "الرئيسية", toolTitle: "مولد رموز QR",
                qrTypeSelectLabel: "نوع رمز QR",
                generateBtnText: "إنشاء رمز QR", downloadBtnText: "تحميل",
                qrPlaceholder: "سيظهر رمز QR هنا", contactText: "اتصل بنا:",
                themeToggleTitleLight: "التبديل إلى الوضع الداكن", themeToggleTitleDark: "التبديل إلى الوضع الفاتح",
                qrTypes: {
                    text: { name: "نص / رابط URL", explanation: "ترميز أي نص أو عنوان ويب (URL)." },
                    email: { name: "بريد إلكتروني", explanation: "إنشاء رمز QR لمسودة بريد إلكتروني." },
                    sms: { name: "رسالة نصية SMS", explanation: "إنشاء رمز QR لإرسال رسالة نصية." },
                    phone: { name: "مكالمة هاتفية", explanation: "إنشاء رمز QR لبدء مكالمة هاتفية." },
                    wifi: { name: "شبكة واي فاي", explanation: "مشاركة بيانات اعتماد شبكة واي فاي بسهولة." },
                    contact: { name: "جهة اتصال (vCard)", explanation: "مشاركة تفاصيل الاتصال لدفاتر العناوين." },
                    event: { name: "حدث تقويم", explanation: "إنشاء رمز QR لحدث في التقويم." },
                    geo: { name: "تحديد الموقع الجغرافي", explanation: "مشاركة موقع جغرافي محدد على الخريطة." }
                },
                fields: {
                    textData: "النص أو الرابط",
                    emailTo: "إلى (عنوان البريد)", emailSubject: "الموضوع", emailBody: "محتوى الرسالة",
                    smsNumber: "رقم الهاتف", smsMessage: "الرسالة",
                    phoneNumber: "رقم الهاتف",
                    wifiSsid: "اسم الشبكة (SSID)", wifiPassword: "كلمة المرور", wifiEncryption: "التشفير", wifiHidden: "شبكة مخفية",
                    contactFirstName: "الاسم الأول", contactLastName: "اسم العائلة", contactOrg: "المؤسسة", contactTitle: "المنصب",
                    contactPhoneMobile: "الهاتف المحمول", contactPhoneWork: "هاتف العمل", contactEmail: "البريد الإلكتروني", contactWebsite: "الموقع الإلكتروني", contactAddress: "العنوان (الشارع، المدينة، الرمز البريدي، البلد)",
                    eventTitle: "عنوان الحدث", eventStart: "تاريخ ووقت البدء", eventEnd: "تاريخ ووقت الانتهاء", eventLocation: "الموقع", eventDescription: "الوصف",
                    geoLatitude: "خط العرض", geoLongitude: "خط الطول"
                },
                wifiEncryptionOptions: { none: "بدون", WEP: "WEP", WPA: "WPA/WPA2" }
            }
        };

        // --- Global Variables & DOM Elements ---
        let currentLang = 'en';
        let currentTheme = 'light';
        let qrInstance = null;

        const body = document.body;
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeToggleIcon = themeToggleBtn.querySelector('i');
        const qrTypeSelect = document.getElementById('qrTypeSelect');
        const dynamicInputsContainer = document.getElementById('dynamicInputsContainer');
        const qrTypeExplanationDiv = document.getElementById('qrTypeExplanation');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const qrCodeCanvas = document.getElementById('qrCodeCanvas');
        const qrPlaceholder = document.getElementById('qrPlaceholder');

        // --- QR Type Definitions & Input Rendering ---
        const qrTypeDefinitions = {
            text: {
                fields: [ { id: 'textData', type: 'textarea', labelKey: 'textData', placeholder: 'https://example.com or Your Text' } ],
                formatter: (values) => values.textData
            },
            email: {
                fields: [
                    { id: 'emailTo', type: 'email', labelKey: 'emailTo', required: true },
                    { id: 'emailSubject', type: 'text', labelKey: 'emailSubject' },
                    { id: 'emailBody', type: 'textarea', labelKey: 'emailBody' }
                ],
                formatter: (values) => `mailto:${values.emailTo || ''}?subject=${encodeURIComponent(values.emailSubject || '')}&body=${encodeURIComponent(values.emailBody || '')}`
            },
            sms: {
                fields: [
                    { id: 'smsNumber', type: 'tel', labelKey: 'smsNumber', required: true },
                    { id: 'smsMessage', type: 'textarea', labelKey: 'smsMessage' }
                ],
                formatter: (values) => `SMSTO:${values.smsNumber || ''}:${encodeURIComponent(values.smsMessage || '')}`
            },
            phone: {
                fields: [ { id: 'phoneNumber', type: 'tel', labelKey: 'phoneNumber', required: true } ],
                formatter: (values) => `TEL:${values.phoneNumber || ''}`
            },
            wifi: {
                fields: [
                    { id: 'wifiSsid', type: 'text', labelKey: 'wifiSsid', required: true },
                    { id: 'wifiPassword', type: 'text', labelKey: 'wifiPassword' }, // type="password" makes it hard to see
                    { id: 'wifiEncryption', type: 'select', labelKey: 'wifiEncryption', optionsKey: 'wifiEncryptionOptions', defaultValue: 'WPA' },
                    { id: 'wifiHidden', type: 'checkbox', labelKey: 'wifiHidden' }
                ],
                formatter: (values) => `WIFI:S:${values.wifiSsid || ''};T:${values.wifiEncryption || 'nopass'};P:${values.wifiPassword || ''};H:${values.wifiHidden ? 'true' : 'false'};`
            },
            contact: {
                fields: [
                    { id: 'contactFirstName', type: 'text', labelKey: 'contactFirstName' },
                    { id: 'contactLastName', type: 'text', labelKey: 'contactLastName', required: true },
                    { id: 'contactOrg', type: 'text', labelKey: 'contactOrg' },
                    { id: 'contactTitle', type: 'text', labelKey: 'contactTitle' },
                    { id: 'contactPhoneMobile', type: 'tel', labelKey: 'contactPhoneMobile' },
                    { id: 'contactPhoneWork', type: 'tel', labelKey: 'contactPhoneWork' },
                    { id: 'contactEmail', type: 'email', labelKey: 'contactEmail' },
                    { id: 'contactWebsite', type: 'url', labelKey: 'contactWebsite' },
                    { id: 'contactAddress', type: 'textarea', labelKey: 'contactAddress', placeholder: 'Street;City;ZIP;Country' }
                ],
                formatter: (values) => {
                    let vCard = "BEGIN:VCARD\nVERSION:3.0\n";
                    if (values.contactLastName) vCard += `N:${values.contactLastName};${values.contactFirstName || ''}\n`;
                    if (values.contactFirstName || values.contactLastName) vCard += `FN:${values.contactFirstName || ''} ${values.contactLastName || ''}\n`;
                    if (values.contactOrg) vCard += `ORG:${values.contactOrg}\n`;
                    if (values.contactTitle) vCard += `TITLE:${values.contactTitle}\n`;
                    if (values.contactPhoneMobile) vCard += `TEL;TYPE=CELL:${values.contactPhoneMobile}\n`;
                    if (values.contactPhoneWork) vCard += `TEL;TYPE=WORK:${values.contactPhoneWork}\n`;
                    if (values.contactEmail) vCard += `EMAIL:${values.contactEmail}\n`;
                    if (values.contactWebsite) vCard += `URL:${values.contactWebsite}\n`;
                    if (values.contactAddress) { // ADR:;;Street;City;Region;PostalCode;Country
                        const addrParts = values.contactAddress.split(';').map(s => s.trim());
                        vCard += `ADR;TYPE=WORK:;;${addrParts[0]||''};${addrParts[1]||''};;${addrParts[2]||''};${addrParts[3]||''}\n`;
                    }
                    vCard += "END:VCARD";
                    return vCard;
                }
            },
            event: {
                fields: [
                    { id: 'eventTitle', type: 'text', labelKey: 'eventTitle', required: true },
                    { id: 'eventStart', type: 'datetime-local', labelKey: 'eventStart', required: true },
                    { id: 'eventEnd', type: 'datetime-local', labelKey: 'eventEnd', required: true },
                    { id: 'eventLocation', type: 'text', labelKey: 'eventLocation' },
                    { id: 'eventDescription', type: 'textarea', labelKey: 'eventDescription' }
                ],
                formatter: (values) => {
                    const formatDate = (datetimeLocal) => { // YYYYMMDDTHHMMSSZ
                        if (!datetimeLocal) return '';
                        return datetimeLocal.replace(/[-:]/g, '').replace('T', 'T') + '00Z'; // Simplistic, assumes local time is effectively UTC for QR
                    };
                    let iCal = "BEGIN:VEVENT\n";
                    if (values.eventTitle) iCal += `SUMMARY:${values.eventTitle}\n`;
                    if (values.eventStart) iCal += `DTSTART:${formatDate(values.eventStart)}\n`;
                    if (values.eventEnd) iCal += `DTEND:${formatDate(values.eventEnd)}\n`;
                    if (values.eventLocation) iCal += `LOCATION:${values.eventLocation}\n`;
                    if (values.eventDescription) iCal += `DESCRIPTION:${encodeURIComponent(values.eventDescription)}\n`;
                    iCal += "END:VEVENT";
                    return iCal;
                }
            },
            geo: {
                fields: [
                    { id: 'geoLatitude', type: 'number', labelKey: 'geoLatitude', step: 'any', required: true },
                    { id: 'geoLongitude', type: 'number', labelKey: 'geoLongitude', step: 'any', required: true }
                ],
                formatter: (values) => `geo:${values.geoLatitude || 0},${values.geoLongitude || 0}`
            }
        };

        function renderDynamicInputs(type) {
            dynamicInputsContainer.innerHTML = '';
            const definition = qrTypeDefinitions[type];
            if (!definition) return;

            const langFields = languages[currentLang].fields;

            definition.fields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'input-group' + (field.type === 'checkbox' ? ' checkbox-group' : '');

                const label = document.createElement('label');
                label.htmlFor = field.id;
                label.textContent = langFields[field.labelKey] || field.labelKey;
                if (field.required) label.textContent += ' *';

                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                } else if (field.type === 'select') {
                    input = document.createElement('select');
                    const optionsSource = languages[currentLang][field.optionsKey] || languages.en[field.optionsKey];
                    for (const optValue in optionsSource) {
                        const option = document.createElement('option');
                        option.value = optValue;
                        option.textContent = optionsSource[optValue];
                        input.appendChild(option);
                    }
                    if(field.defaultValue) input.value = field.defaultValue;

                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    if (field.step) input.step = field.step;
                }
                input.id = field.id;
                input.name = field.id;
                if (field.placeholder) input.placeholder = field.placeholder; // Placeholder localization needed if specific
                if (field.required) input.required = true;

                if (field.type === 'checkbox') {
                    group.appendChild(input); // Checkbox first
                    group.appendChild(label);
                } else {
                    group.appendChild(label);
                    group.appendChild(input);
                }
                dynamicInputsContainer.appendChild(group);
            });
            updateQRTypeExplanation(type);
        }

        function updateQRTypeExplanation(type) {
            const explanationText = languages[currentLang].qrTypes[type]?.explanation;
            if (explanationText) {
                qrTypeExplanationDiv.textContent = explanationText;
                qrTypeExplanationDiv.style.display = 'block';
            } else {
                qrTypeExplanationDiv.style.display = 'none';
            }
        }


        // --- Theme Management ---
        function applyTheme(theme) {
            currentTheme = theme;
            body.classList.toggle('dark-mode', theme === 'dark');
            themeToggleIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            themeToggleBtn.title = theme === 'dark' ? languages[currentLang].themeToggleTitleDark : languages[currentLang].themeToggleTitleLight;
            localStorage.setItem('qrGeneratorTheme', theme);
        }
        themeToggleBtn.addEventListener('click', () => {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        // --- Language Management ---
        function updateLanguage(lang) {
            currentLang = lang;
            const langData = languages[lang];
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

            document.getElementById('appTitle').textContent = langData.appTitle;
            document.getElementById('homeText').textContent = langData.home;
            document.getElementById('toolTitle').textContent = langData.toolTitle;
            document.getElementById('qrTypeSelectLabel').textContent = langData.qrTypeSelectLabel;
            document.getElementById('generateBtnText').textContent = langData.generateBtnText;
            document.getElementById('downloadBtnText').textContent = langData.downloadBtnText;
            qrPlaceholder.textContent = langData.qrPlaceholder;
            document.getElementById('contactText').textContent = langData.contactText;
            themeToggleBtn.title = currentTheme === 'dark' ? langData.themeToggleTitleDark : langData.themeToggleTitleLight;


            // Update QR Type Select Options
            const selectOptions = qrTypeSelect.options;
            for (let i = 0; i < selectOptions.length; i++) {
                const optionValue = selectOptions[i].value;
                if (langData.qrTypes[optionValue]) {
                    selectOptions[i].textContent = langData.qrTypes[optionValue].name;
                }
            }
            // Re-render inputs for current type to update labels
            renderDynamicInputs(qrTypeSelect.value);
            document.title = `${langData.toolTitle} - ${langData.appTitle}`;
            localStorage.setItem('qrGeneratorLang', lang);

            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
        }

        document.querySelectorAll('.lang-btn').forEach(button => {
            button.addEventListener('click', () => updateLanguage(button.dataset.lang));
        });

        // --- QR Code Generation & Download ---
        function generateQRCode() {
            const type = qrTypeSelect.value;
            const definition = qrTypeDefinitions[type];
            if (!definition) return;

            const values = {};
            let allRequiredFilled = true;
            definition.fields.forEach(field => {
                const inputElement = document.getElementById(field.id);
                if (inputElement) {
                    values[field.id] = field.type === 'checkbox' ? inputElement.checked : inputElement.value.trim();
                    if (field.required && !values[field.id] && field.type !== 'checkbox') { // Checkboxes can be false
                        allRequiredFilled = false;
                        inputElement.style.borderColor = 'var(--danger-color, red)'; // Add a danger color to :root
                    } else if (inputElement.style) {
                        inputElement.style.borderColor = '';
                    }
                }
            });

            if (!allRequiredFilled) {
                 alert(currentLang === 'ar' ? 'يرجى ملء جميع الحقول المطلوبة (*).' : (currentLang === 'fr' ? 'Veuillez remplir tous les champs obligatoires (*).' : 'Please fill in all required fields (*).'));
                return;
            }


            const qrDataString = definition.formatter(values);

            if (!qrDataString && type !== 'text') { // Text can be empty for an "empty" QR
                // this case might be handled by required fields already
                qrCodeCanvas.style.display = 'none';
                qrPlaceholder.style.display = 'flex';
                downloadBtn.style.display = 'none';
                return;
            }
            
            qrCodeCanvas.style.display = 'block';
            qrPlaceholder.style.display = 'none';
            downloadBtn.style.display = 'block'; // Changed to block to match button class

            qrInstance = new QRious({
                element: qrCodeCanvas,
                value: qrDataString,
                size: 400, // Fixed size
                level: 'H', // High error correction
                foreground: 'black', // Fixed colors for simplicity
                background: 'white',
                padding: 15 // A bit of padding
            });
        }

        function downloadQRCode() {
            if (!qrInstance || qrCodeCanvas.style.display === 'none') {
                 alert(currentLang === 'ar' ? 'لم يتم إنشاء رمز QR بعد.' : (currentLang === 'fr' ? 'Aucun code QR n\'a encore été généré.' : 'No QR code has been generated yet.'));
                return;
            }
            const dataURL = qrCodeCanvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `qrcode-${qrTypeSelect.value}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // --- Event Listeners & Initialization ---
        qrTypeSelect.addEventListener('change', (e) => {
            renderDynamicInputs(e.target.value);
            // Clear previous QR on type change
            qrCodeCanvas.style.display = 'none';
            qrPlaceholder.style.display = 'flex';
            downloadBtn.style.display = 'none';
            qrInstance = null;
             localStorage.setItem('qrGeneratorType', e.target.value);
        });

        generateBtn.addEventListener('click', generateQRCode);
        downloadBtn.addEventListener('click', downloadQRCode);

        function loadSettings() {
            const savedLang = localStorage.getItem('qrGeneratorLang') || 'en';
            const savedTheme = localStorage.getItem('qrGeneratorTheme') || 'light';
            const savedType = localStorage.getItem('qrGeneratorType') || 'text';

            applyTheme(savedTheme); // Apply theme first
            
            if (Array.from(qrTypeSelect.options).some(opt => opt.value === savedType)) {
                qrTypeSelect.value = savedType;
            }
            renderDynamicInputs(qrTypeSelect.value); // Render inputs for saved type
            updateLanguage(savedLang); // Then update language, which also re-renders inputs with correct labels
            
            // Note: We are not restoring individual field values for simplicity on type change.
            // User will typically re-enter data for a new type or when returning.
        }

        // --- Initial Load ---
        loadSettings();

    </script>
</body>
</html>